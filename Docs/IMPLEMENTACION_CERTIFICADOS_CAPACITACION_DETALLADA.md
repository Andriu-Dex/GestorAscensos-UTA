# Implementaci√≥n de Certificados de Capacitaci√≥n - Documentaci√≥n Detallada

## üìã Resumen de la Implementaci√≥n

Esta documentaci√≥n describe la implementaci√≥n completa de la funcionalidad de "Certificados de Capacitaci√≥n" en el sistema SGA (Sistema de Gesti√≥n de Ascensos), desarrollada siguiendo el patr√≥n arquitect√≥nico de "Obras Acad√©micas" existente en el sistema.

**Fecha de implementaci√≥n:** Julio 2, 2025  
**Desarrollador:** Implementaci√≥n asistida por IA  
**Patr√≥n seguido:** Arquitectura de "Obras Acad√©micas"

## üéØ Objetivos Cumplidos

‚úÖ **Gesti√≥n completa de certificados:** Subir, editar, eliminar y gestionar certificados PDF  
‚úÖ **Metadatos detallados:** T√≠tulo, descripci√≥n, horas de capacitaci√≥n, fecha de emisi√≥n  
‚úÖ **Flujo de aprobaci√≥n:** Sistema de aprobaci√≥n/rechazo por administradores  
‚úÖ **Integraci√≥n UI:** Vista "Mis Documentos" con secci√≥n dedicada  
‚úÖ **Validaciones:** Archivos PDF, tama√±o, campos obligatorios  
‚úÖ **Notificaciones:** Sistema de notificaciones para cambios de estado  
‚úÖ **Migraci√≥n BD:** Base de datos actualizada con nueva tabla

## üèóÔ∏è Arquitectura Implementada

### Backend (Clean Architecture)

```
SGA.Domain/
‚îú‚îÄ‚îÄ Entities/
‚îÇ   ‚îî‚îÄ‚îÄ SolicitudCertificadoCapacitacion.cs ‚Üê Nueva entidad
‚îÇ
SGA.Application/
‚îú‚îÄ‚îÄ DTOs/
‚îÇ   ‚îî‚îÄ‚îÄ CertificadosCapacitacionDto.cs ‚Üê DTOs para transferencia
‚îú‚îÄ‚îÄ Interfaces/
‚îÇ   ‚îú‚îÄ‚îÄ ICertificadosCapacitacionService.cs ‚Üê Interfaz del servicio
‚îÇ   ‚îî‚îÄ‚îÄ INotificationService.cs ‚Üê Extendida para certificados
‚îî‚îÄ‚îÄ Services/
    ‚îú‚îÄ‚îÄ CertificadosCapacitacionService.cs ‚Üê L√≥gica de negocio
    ‚îî‚îÄ‚îÄ NotificationService.cs ‚Üê Notificaciones actualizadas

SGA.Infrastructure/
‚îú‚îÄ‚îÄ Data/
‚îÇ   ‚îî‚îÄ‚îÄ ApplicationDbContext.cs ‚Üê DbSet agregado
‚îî‚îÄ‚îÄ Migrations/
    ‚îî‚îÄ‚îÄ 20250702041053_AddCertificadosCapacitacion.cs ‚Üê Nueva migraci√≥n

SGA.Api/
‚îî‚îÄ‚îÄ Controllers/
    ‚îî‚îÄ‚îÄ CertificadosCapacitacionController.cs ‚Üê API REST
```

### Frontend (Blazor Server)

```
SGA.Web/
‚îî‚îÄ‚îÄ Pages/
    ‚îî‚îÄ‚îÄ Documentos.razor ‚Üê UI integrada con secci√≥n de certificados
```

## üìä Base de Datos

### Nueva Tabla: SolicitudCertificadoCapacitacion

```sql
CREATE TABLE [dbo].[SolicitudCertificadoCapacitacion] (
    [Id] int IDENTITY(1,1) NOT NULL,
    [DocenteId] int NOT NULL,
    [Titulo] nvarchar(200) NOT NULL,
    [Descripcion] nvarchar(1000) NULL,
    [HorasCapacitacion] int NOT NULL,
    [FechaEmision] datetime2 NOT NULL,
    [NombreArchivo] nvarchar(255) NOT NULL,
    [RutaArchivo] nvarchar(500) NOT NULL,
    [TamanioArchivo] bigint NOT NULL,
    [Estado] int NOT NULL,
    [MotivoRechazo] nvarchar(500) NULL,
    [FechaCreacion] datetime2 NOT NULL,
    [FechaActualizacion] datetime2 NOT NULL,
    [CreadoPor] nvarchar(100) NOT NULL,
    [ActualizadoPor] nvarchar(100) NOT NULL,
    CONSTRAINT [PK_SolicitudCertificadoCapacitacion] PRIMARY KEY ([Id]),
    CONSTRAINT [FK_SolicitudCertificadoCapacitacion_Docentes_DocenteId]
        FOREIGN KEY ([DocenteId]) REFERENCES [dbo].[Docentes] ([Id]) ON DELETE CASCADE
);
```

### Estados del Certificado

```csharp
public enum EstadoSolicitud
{
    Pendiente = 1,
    Aprobado = 2,
    Rechazado = 3
}
```

## üîß Implementaci√≥n Detallada

### 1. Entidad de Dominio

**Archivo:** `SGA.Domain/Entities/SolicitudCertificadoCapacitacion.cs`

```csharp
public class SolicitudCertificadoCapacitacion : BaseEntity
{
    public int DocenteId { get; set; }
    public string Titulo { get; set; } = string.Empty;
    public string? Descripcion { get; set; }
    public int HorasCapacitacion { get; set; }
    public DateTime FechaEmision { get; set; }
    public string NombreArchivo { get; set; } = string.Empty;
    public string RutaArchivo { get; set; } = string.Empty;
    public long TamanioArchivo { get; set; }
    public EstadoSolicitud Estado { get; set; } = EstadoSolicitud.Pendiente;
    public string? MotivoRechazo { get; set; }

    // Relaci√≥n
    public virtual Docente Docente { get; set; } = null!;
}
```

**Caracter√≠sticas:**

- Hereda de `BaseEntity` (auditoria autom√°tica)
- Validaciones de longitud y requerimientos
- Relaci√≥n con entidad `Docente`
- Estados claramente definidos

### 2. DTOs de Aplicaci√≥n

**Archivo:** `SGA.Application/DTOs/CertificadosCapacitacionDto.cs`

Implementa 4 DTOs especializados:

```csharp
// Para respuestas de consulta
public class CertificadoCapacitacionDto
{
    public int Id { get; set; }
    public string Titulo { get; set; } = string.Empty;
    public string? Descripcion { get; set; }
    public int HorasCapacitacion { get; set; }
    public DateTime FechaEmision { get; set; }
    public string NombreArchivo { get; set; } = string.Empty;
    public long TamanioArchivo { get; set; }
    public EstadoSolicitud Estado { get; set; }
    public string? MotivoRechazo { get; set; }
    public DateTime FechaCreacion { get; set; }
}

// Para crear nuevos certificados
public class CrearCertificadoCapacitacionDto
{
    public string Titulo { get; set; } = string.Empty;
    public string? Descripcion { get; set; }
    public int HorasCapacitacion { get; set; }
    public DateTime FechaEmision { get; set; }
    public IFormFile Archivo { get; set; } = null!;
}

// Para actualizar certificados existentes
public class ActualizarCertificadoCapacitacionDto
{
    public string Titulo { get; set; } = string.Empty;
    public string? Descripcion { get; set; }
    public int HorasCapacitacion { get; set; }
    public DateTime FechaEmision { get; set; }
}

// Para reemplazar archivos
public class ReemplazarArchivoCertificadoDto
{
    public IFormFile Archivo { get; set; } = null!;
}
```

### 3. Servicio de Aplicaci√≥n

**Archivo:** `SGA.Application/Services/CertificadosCapacitacionService.cs`

**M√©todos implementados:**

```csharp
public interface ICertificadosCapacitacionService
{
    Task<IEnumerable<CertificadoCapacitacionDto>> ObtenerCertificadosPorDocenteAsync(int docenteId);
    Task<CertificadoCapacitacionDto?> ObtenerCertificadoPorIdAsync(int id);
    Task<CertificadoCapacitacionDto> CrearCertificadoAsync(int docenteId, CrearCertificadoCapacitacionDto dto);
    Task<CertificadoCapacitacionDto> ActualizarCertificadoAsync(int id, ActualizarCertificadoCapacitacionDto dto);
    Task<bool> EliminarCertificadoAsync(int id);
    Task<CertificadoCapacitacionDto> ReemplazarArchivoAsync(int id, ReemplazarArchivoCertificadoDto dto);
    Task<bool> AprobarCertificadoAsync(int id);
    Task<bool> RechazarCertificadoAsync(int id, string motivo);
}
```

**Funcionalidades clave:**

- ‚úÖ Validaci√≥n de archivos PDF (tipo MIME, extensi√≥n)
- ‚úÖ Gesti√≥n de archivos en sistema de archivos
- ‚úÖ Control de tama√±o m√°ximo (10MB)
- ‚úÖ Manejo de transacciones
- ‚úÖ Logging integrado
- ‚úÖ Notificaciones autom√°ticas

### 4. Controlador API

**Archivo:** `SGA.Api/Controllers/CertificadosCapacitacionController.cs`

**Endpoints REST implementados:**

```http
GET    /api/certificados-capacitacion          # Obtener certificados del docente
GET    /api/certificados-capacitacion/{id}     # Obtener certificado espec√≠fico
POST   /api/certificados-capacitacion          # Crear nuevo certificado
PUT    /api/certificados-capacitacion/{id}     # Actualizar certificado
DELETE /api/certificados-capacitacion/{id}     # Eliminar certificado
PUT    /api/certificados-capacitacion/{id}/archivo # Reemplazar archivo
PUT    /api/certificados-capacitacion/{id}/aprobar # Aprobar certificado (Admin)
PUT    /api/certificados-capacitacion/{id}/rechazar # Rechazar certificado (Admin)
```

**Caracter√≠sticas:**

- ‚úÖ Autorizaci√≥n basada en roles
- ‚úÖ Validaci√≥n de modelos
- ‚úÖ Manejo de errores HTTP est√°ndar
- ‚úÖ Documentaci√≥n Swagger autom√°tica
- ‚úÖ Logging de operaciones

### 5. Frontend Blazor

**Archivo:** `SGA.Web/Pages/Documentos.razor`

**Componentes UI implementados:**

#### Secci√≥n Principal

```html
<div class="row mb-4">
  <div class="col-12">
    <h4><i class="fas fa-certificate me-2"></i>Certificados de Capacitaci√≥n</h4>
    <button
      class="btn btn-primary mb-3"
      @onclick="AbrirModalAgregarCertificado"
    >
      <i class="fas fa-plus me-2"></i>Agregar Certificado
    </button>
  </div>
</div>
```

#### Tabla de Certificados

- ‚úÖ Visualizaci√≥n de metadatos completos
- ‚úÖ Estados con badges coloridos
- ‚úÖ Acciones contextuales por estado
- ‚úÖ Responsive design

#### Modales Implementados

1. **Modal Agregar Certificado**

   - Formulario completo con validaciones
   - Upload de archivo PDF
   - Campos: t√≠tulo, descripci√≥n, horas, fecha

2. **Modal Editar Certificado**

   - Solo metadatos (no archivo)
   - Validaciones client-side

3. **Modal Reemplazar Archivo**

   - Solo para cambiar el PDF
   - Validaci√≥n de tipo de archivo

4. **Modal Ver Motivo de Rechazo**
   - Visualizaci√≥n de motivos de rechazo
   - Solo lectura

**Validaciones Frontend:**

```csharp
private bool ValidarFormularioCertificado()
{
    return !string.IsNullOrWhiteSpace(certificadoTemporal.Titulo) &&
           certificadoTemporal.HorasCapacitacion > 0 &&
           certificadoTemporal.FechaEmision != default;
}

private bool ValidarArchivoPDF(IBrowserFile file)
{
    return file.ContentType == "application/pdf" &&
           file.Size <= 10 * 1024 * 1024; // 10MB
}
```

## üîî Sistema de Notificaciones

Se extendi√≥ el sistema existente para incluir notificaciones de certificados:

**Archivo:** `SGA.Application/Services/NotificationService.cs`

```csharp
public async Task NotificarCambioEstadoCertificadoAsync(int docenteId, string titulo, EstadoSolicitud estado, string? motivo = null)
{
    var mensaje = estado switch
    {
        EstadoSolicitud.Aprobado => $"Tu certificado '{titulo}' ha sido aprobado",
        EstadoSolicitud.Rechazado => $"Tu certificado '{titulo}' ha sido rechazado. Motivo: {motivo}",
        _ => $"El estado de tu certificado '{titulo}' ha cambiado"
    };

    var notificacion = new Notificacion
    {
        DocenteId = docenteId,
        Mensaje = mensaje,
        Tipo = "CertificadoCapacitacion",
        FechaCreacion = DateTime.UtcNow,
        Leida = false
    };

    await _notificacionRepository.CrearAsync(notificacion);
}
```

## üìÅ Gesti√≥n de Archivos

### Estructura de Directorios

```
SGA.Api/uploads/certificados-capacitacion/
‚îú‚îÄ‚îÄ {docenteId}/
‚îÇ   ‚îú‚îÄ‚îÄ certificado-{certificadoId}-{timestamp}.pdf
‚îÇ   ‚îî‚îÄ‚îÄ certificado-{certificadoId}-{timestamp}.pdf
```

### Validaciones Implementadas

- ‚úÖ **Tipo de archivo:** Solo PDF (`application/pdf`)
- ‚úÖ **Tama√±o m√°ximo:** 10MB
- ‚úÖ **Extensi√≥n:** `.pdf`
- ‚úÖ **Nombres √∫nicos:** Timestamp + ID para evitar colisiones

## üîß Configuraci√≥n y Dependencias

### Registro de Servicios

**Archivo:** `SGA.Application/DependencyInjection.cs`

```csharp
public static IServiceCollection AddApplicationServices(this IServiceCollection services)
{
    // ... servicios existentes ...

    services.AddScoped<ICertificadosCapacitacionService, CertificadosCapacitacionService>();

    return services;
}
```

### Configuraci√≥n de Base de Datos

**Archivo:** `SGA.Infrastructure/Data/ApplicationDbContext.cs`

```csharp
public DbSet<SolicitudCertificadoCapacitacion> SolicitudCertificadoCapacitacion { get; set; }

protected override void OnModelCreating(ModelBuilder modelBuilder)
{
    base.OnModelCreating(modelBuilder);

    // Configuraci√≥n de entidad
    modelBuilder.Entity<SolicitudCertificadoCapacitacion>(entity =>
    {
        entity.HasKey(e => e.Id);
        entity.Property(e => e.Titulo).HasMaxLength(200).IsRequired();
        entity.Property(e => e.Descripcion).HasMaxLength(1000);
        entity.Property(e => e.NombreArchivo).HasMaxLength(255).IsRequired();
        entity.Property(e => e.RutaArchivo).HasMaxLength(500).IsRequired();
        entity.Property(e => e.MotivoRechazo).HasMaxLength(500);

        entity.HasOne(e => e.Docente)
              .WithMany()
              .HasForeignKey(e => e.DocenteId)
              .OnDelete(DeleteBehavior.Cascade);
    });
}
```

## üóÑÔ∏è Migraci√≥n de Base de Datos

### Comandos Ejecutados

```bash
# Crear migraci√≥n
dotnet ef migrations add AddCertificadosCapacitacion -p SGA.Infrastructure -s SGA.Api

# Aplicar migraci√≥n
dotnet ef database update -p SGA.Infrastructure -s SGA.Api
```

### Archivo de Migraci√≥n

**Archivo:** `SGA.Infrastructure/Migrations/20250702041053_AddCertificadosCapacitacion.cs`

- ‚úÖ Crea tabla `SolicitudCertificadoCapacitacion`
- ‚úÖ Configura √≠ndices y relaciones
- ‚úÖ Define constraints y tipos de datos
- ‚úÖ Incluye rollback completo

## üß™ Validaci√≥n y Pruebas

### Compilaci√≥n Exitosa

```bash
# Backend
dotnet build
‚úÖ Build succeeded.

# Frontend
dotnet build SGA.Web
‚úÖ Build succeeded.
```

### Validaciones Implementadas

#### Backend

- ‚úÖ Validaci√≥n de archivos PDF
- ‚úÖ Control de tama√±o (10MB m√°x)
- ‚úÖ Validaci√≥n de campos obligatorios
- ‚úÖ Autorizaci√≥n por roles
- ‚úÖ Manejo de errores

#### Frontend

- ‚úÖ Validaci√≥n client-side de formularios
- ‚úÖ Feedback visual de estados
- ‚úÖ Confirmaciones de acciones destructivas
- ‚úÖ Loading states durante operaciones

## üìã Estados y Flujo de Trabajo

### Estados del Certificado

1. **Pendiente** (Default)

   - üü° Badge amarillo
   - Acciones: Editar, Eliminar, Reemplazar archivo

2. **Aprobado**

   - üü¢ Badge verde
   - Acciones: Solo visualizaci√≥n

3. **Rechazado**
   - üî¥ Badge rojo
   - Acciones: Ver motivo, Editar, Reemplazar archivo

### Flujo de Aprobaci√≥n

```mermaid
graph TD
    A[Docente sube certificado] --> B[Estado: Pendiente]
    B --> C{Admin revisa}
    C -->|Aprueba| D[Estado: Aprobado]
    C -->|Rechaza| E[Estado: Rechazado]
    E --> F[Docente puede editar/reemplazar]
    F --> B
    D --> G[Proceso completado]
```

## üé® Interfaz de Usuario

### Componentes Visuales

#### Badges de Estado

```html
@if (certificado.Estado == EstadoSolicitud.Pendiente) {
<span class="badge bg-warning">Pendiente</span>
} else if (certificado.Estado == EstadoSolicitud.Aprobado) {
<span class="badge bg-success">Aprobado</span>
} else if (certificado.Estado == EstadoSolicitud.Rechazado) {
<span class="badge bg-danger">Rechazado</span>
}
```

#### Acciones Contextuales

- **Estado Pendiente:** Editar | Eliminar | Reemplazar
- **Estado Aprobado:** Ver (solo lectura)
- **Estado Rechazado:** Ver motivo | Editar | Reemplazar

### Responsive Design

- ‚úÖ Tabla responsive con scroll horizontal
- ‚úÖ Modales adaptables a m√≥viles
- ‚úÖ Iconos FontAwesome consistentes
- ‚úÖ Bootstrap 5 styling

## üîê Seguridad Implementada

### Autorizaci√≥n

```csharp
[Authorize] // Requiere autenticaci√≥n
public class CertificadosCapacitacionController : ControllerBase
{
    [HttpPut("{id}/aprobar")]
    [Authorize(Roles = "Admin")] // Solo administradores
    public async Task<IActionResult> Aprobar(int id)

    [HttpGet]
    public async Task<IActionResult> ObtenerCertificados()
    {
        // Solo certificados del docente actual
        var docenteId = _authService.ObtenerDocenteIdActual();
    }
}
```

### Validaciones de Archivos

- ‚úÖ Tipo MIME verificado
- ‚úÖ Extensi√≥n validada
- ‚úÖ Tama√±o limitado
- ‚úÖ Nombres de archivo sanitizados

## üìà Rendimiento y Optimizaciones

### Base de Datos

- ‚úÖ √çndices en campos de b√∫squeda frecuente
- ‚úÖ Relaciones optimizadas con `Include()`
- ‚úÖ Queries espec√≠ficas por contexto

### Frontend

- ‚úÖ Loading states durante operaciones
- ‚úÖ Validaci√≥n client-side antes de env√≠o
- ‚úÖ Manejo eficiente de estado local
- ‚úÖ Reutilizaci√≥n de componentes

## ‚ö†Ô∏è Consideraciones Importantes

### Limitaciones Actuales

- üìÅ **Archivos:** Solo PDFs (extensible)
- üìè **Tama√±o:** 10MB m√°ximo
- üë§ **Roles:** Docente/Admin (no otros roles)
- üîÑ **Estados:** Flujo lineal (no re-aprobaciones autom√°ticas)

### √Åreas de Mejora Futuras

- üéØ **Dashboard administrativo** para gesti√≥n masiva
- üìä **Reportes** de certificados por per√≠odo
- üîî **Notificaciones email** adem√°s de sistema
- üì± **App m√≥vil** para gesti√≥n remota
- üîç **B√∫squeda avanzada** con filtros
- üìã **Plantillas** de certificados comunes

## üõ†Ô∏è Mantenimiento

### Archivos Clave para Monitoreo

1. `SGA.Api/uploads/certificados-capacitacion/` - Archivos subidos
2. `Logs/` - Logs de operaciones
3. Base de datos - Tabla `SolicitudCertificadoCapacitacion`

### Comandos √ötiles

```bash
# Ver estado de migraciones
dotnet ef migrations list -p SGA.Infrastructure -s SGA.Api

# Rollback si necesario
dotnet ef database update PreviousMigration -p SGA.Infrastructure -s SGA.Api

# Limpiar y reconstruir
dotnet clean && dotnet build
```

## üìö Referencias y Documentaci√≥n

### Archivos de Documentaci√≥n

- `README_VARIABLES_ENTORNO.md` - Configuraci√≥n de entorno
- `SETUP_RAPIDO.md` - Gu√≠a de inicio r√°pido
- `IMPLEMENTACION_CERTIFICADOS_CAPACITACION.md` - Documentaci√≥n t√©cnica original

### Patrones Seguidos

- **Clean Architecture** - Separaci√≥n de responsabilidades
- **Repository Pattern** - Acceso a datos abstracto
- **DTO Pattern** - Transferencia de datos segura
- **CQRS b√°sico** - Separaci√≥n comandos/consultas

## ‚úÖ Conclusi√≥n

La implementaci√≥n de certificados de capacitaci√≥n se complet√≥ exitosamente siguiendo las mejores pr√°cticas del sistema existente. La funcionalidad est√° completamente integrada, documentada y lista para uso en producci√≥n.

**Resultado:** Sistema robusto, escalable y mantenible que permite a los docentes gestionar sus certificados de capacitaci√≥n con un flujo de aprobaci√≥n administrativo eficiente.

---

**Implementado en:** Julio 2, 2025  
**Estado:** ‚úÖ Completado y funcional  
**Pr√≥ximos pasos:** Pruebas de usuario y mejoras administrativas
