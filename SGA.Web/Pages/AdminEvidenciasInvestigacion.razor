@page "/admin/evidencias-investigacion"
@attribute [Authorize(Roles = "Administrador")]
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components
@using Microsoft.JSInterop
@using Blazored.Toast.Services
@using System.Net.Http.Json
@using System.Net.Http.Headers
@using System.Text.Json
@using System.Text
@using SGA.Web.Shared
@using SGA.Web.Models

<div class="container-fluid mt-4">
    <!-- Encabezado de página mejorado -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <div class="text-left">
                <h3>
                    <i class="bi bi-search me-2"></i>
                    Panel de Administración - Evidencias de Investigación
                </h3>
            </div>
            <button class="btn" style="background-color: #8a1538; border-color: #8a1538; color: white;" @onclick="ActualizarEvidencias">
                <i class="bi bi-arrow-clockwise"></i> Actualizar
            </button>
        </div>
        <div class="d-flex justify-content-left mt-3">
            <div class="btn-group filter-buttons" role="group">
                <button type="button" class="btn @(filtroEstado == "Pendiente" ? "btn-light" : "btn-outline-light")" 
                        @onclick="FiltrarPendientes" title="Ver evidencias pendientes de revisión">
                    <i class="bi bi-hourglass-split me-1"></i>Pendientes (@cantidadPendientes)
                </button>
                <button type="button" class="btn @(filtroEstado == "Aprobada" ? "btn-light" : "btn-outline-light")" 
                        @onclick="FiltrarAprobadas" title="Ver evidencias aprobadas">
                    <i class="bi bi-check-circle me-1"></i>Aprobadas (@cantidadAprobadas)
                </button>
                <button type="button" class="btn @(filtroEstado == "Rechazada" ? "btn-light" : "btn-outline-light")" 
                        @onclick="FiltrarRechazadas" title="Ver evidencias rechazadas">
                    <i class="bi bi-x-circle me-1"></i>Rechazadas (@cantidadRechazadas)
                </button>
                <button type="button" class="btn @(string.IsNullOrEmpty(filtroEstado) ? "btn-light" : "btn-outline-light")" 
                        @onclick="MostrarTodas" title="Ver todas las evidencias">
                    <i class="bi bi-list me-1"></i>Todas (@(evidencias?.Count ?? 0))
                </button>
            </div>
        </div>
    </div>

    <!-- Sección de filtros mejorada -->
    <div class="filters-section">
        <h5 class="filters-title">
            <i class="bi bi-funnel me-2"></i>Filtros de Búsqueda
        </h5>
        <div class="row g-3">
            <div class="col-lg-3 col-md-6 col-sm-12">
                <div class="form-floating">
                    <select class="form-select" id="filtroTipo" @bind="filtroTipo" @bind:after="AplicarFiltros"
                            title="Filtrar por tipo específico de evidencia">
                        <option value="">Todos los tipos</option>
                        <option value="Proyecto">Proyecto</option>
                        <option value="Publicación">Publicación</option>
                        <option value="Participación">Participación</option>
                        <option value="Dirección">Dirección</option>
                        <option value="Colaboración">Colaboración</option>
                    </select>
                    <label for="filtroTipo">
                        <i class="bi bi-tags me-1"></i>Tipo de Evidencia
                    </label>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 col-sm-12">
                <div class="form-floating">
                    <input type="text" class="form-control" id="busquedaTitulo" placeholder=" " 
                           @bind="busquedaTitulo" @bind:after="AplicarFiltros"
                           title="Buscar por título del proyecto o investigación">
                    <label for="busquedaTitulo">
                        <i class="bi bi-search me-1"></i>Título del Proyecto
                    </label>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 col-sm-12">
                <div class="form-floating">
                    <input type="text" class="form-control" id="busquedaDocente" placeholder=" " 
                           @bind="busquedaDocente" @bind:after="AplicarFiltros"
                           title="Buscar por número de cédula del docente">
                    <label for="busquedaDocente">
                        <i class="bi bi-person-badge me-1"></i>Cédula del Docente
                    </label>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 col-sm-12">
                <div class="d-grid h-100">
                    <button class="btn btn-outline-secondary d-flex align-items-center justify-content-center" @onclick="LimpiarFiltros"
                            title="Limpiar todos los filtros aplicados">
                        <i class="bi bi-arrow-counterclockwise me-2"></i>Limpiar Filtros
                    </button>
                </div>
            </div>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="loading-overlay">
            <div class="text-center">
                <div class="spinner-border spinner-custom" role="status">
                    <span class="visually-hidden">Cargando evidencias...</span>
                </div>
                <p class="mt-3 text-custom">Cargando evidencias de investigación...</p>
            </div>
        </div>
    }
    else if (evidenciasFiltradas == null || !evidenciasFiltradas.Any())
    {
        <div class="empty-state fade-in">
            <div class="text-center">
                <i class="bi bi-search fs-1 text-custom mb-3"></i>
                <h4 class="text-custom">No hay evidencias @(filtroEstado?.ToLower() ?? "disponibles")</h4>
                <p class="text-muted mb-0">
                    No se encontraron evidencias de investigación con los filtros seleccionados.
                </p>
                @if (!string.IsNullOrEmpty(filtroEstado) || !string.IsNullOrEmpty(filtroTipo) || !string.IsNullOrEmpty(busquedaTitulo) || !string.IsNullOrEmpty(busquedaDocente))
                {
                    <div class="container-limpiar-filtros">
                        <button class="btn btn-outline-primary" @onclick="LimpiarFiltros"
                                title="Limpiar todos los filtros aplicados">
                            <i class="bi bi-arrow-counterclockwise me-2"></i>Limpiar Filtros
                        </button>
                    </div>
                }
            </div>
        </div>
    }
    else
    {
        <div class="table-responsive fade-in">
            <table class="table table-hover table-bordered">
                <thead>
                    <tr>
                        <th title="Cédula del docente investigador">
                            <i class="bi bi-person-badge me-1"></i>Docente
                        </th>
                        <th title="Tipo de evidencia de investigación">
                            <i class="bi bi-tags me-1"></i>Tipo
                        </th>
                        <th title="Título del proyecto de investigación">
                            <i class="bi bi-journal-text me-1"></i>Título del Proyecto
                        </th>
                        <th title="Institución financiadora">
                            <i class="bi bi-building me-1"></i>Institución
                        </th>
                        <th title="Rol del investigador">
                            <i class="bi bi-person-gear me-1"></i>Rol
                        </th>
                        <th title="Período de duración del proyecto">
                            <i class="bi bi-calendar-range me-1"></i>Período
                        </th>
                        <th title="Estado actual de la evidencia">
                            <i class="bi bi-flag me-1"></i>Estado
                        </th>
                        <th title="Acciones disponibles">
                            <i class="bi bi-gear me-1"></i>Acciones
                        </th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var evidencia in evidenciasFiltradas)
                    {
                        <tr>
                            <td>
                                <strong>@evidencia.DocenteCedula</strong>
                                <br><small class="text-muted">
                                    <EcuadorDateDisplay Date="evidencia.FechaCreacion" 
                                                       Format="date" 
                                                       CssClass="text-muted" />
                                </small>
                            </td>
                            <td>
                                <span class="badge bg-light text-dark">@evidencia.TipoEvidencia</span>
                            </td>
                            <td>
                                <span class="truncate-long" title="@evidencia.TituloProyecto">
                                    @evidencia.TituloProyecto
                                </span>
                                @if (!string.IsNullOrEmpty(evidencia.CodigoProyecto))
                                {
                                    <br><small class="text-muted">Código: @evidencia.CodigoProyecto</small>
                                }
                            </td>
                            <td>
                                <span class="truncate" title="@evidencia.InstitucionFinanciadora">
                                    @evidencia.InstitucionFinanciadora
                                </span>
                            </td>
                            <td>@evidencia.RolInvestigador</td>
                            <td>
                                <small>
                                    <div><strong>Inicio:</strong> @evidencia.FechaInicio.ToString("dd/MM/yyyy")</div>
                                    <div><strong>Fin:</strong> @(evidencia.FechaFin?.ToString("dd/MM/yyyy") ?? "En curso")</div>
                                    <div class="mt-1"><span class="badge bg-info text-white">@evidencia.MesesDuracion meses</span></div>
                                </small>
                            </td>
                            <td class="text-center">
                                <span class="badge @GetBadgeClass(evidencia.Estado)">
                                    @evidencia.Estado
                                </span>
                                @if (evidencia.Estado != "Pendiente" && evidencia.FechaRevision.HasValue)
                                {
                                    <div class="mt-1">
                                        <small class="text-muted">
                                            <EcuadorDateDisplay Date="evidencia.FechaRevision.Value" 
                                                               Format="date" 
                                                               CssClass="text-muted" />
                                        </small>
                                    </div>
                                }
                            </td>
                            <td>
                                <div class="actions-container">
                                    <button class="btn btn-sm btn-outline-primary btn-action" 
                                            @onclick="() => VerDetalle(evidencia)" 
                                            title="Ver información detallada de la evidencia">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    
                                    @if (evidencia.TieneArchivo && !string.IsNullOrEmpty(evidencia.ArchivoNombre))
                                    {
                                        <button class="btn btn-sm btn-outline-secondary btn-action" 
                                                @onclick="() => VisualizarArchivo(evidencia)" 
                                                title="Visualizar evidencia en formato PDF">
                                            <i class="bi bi-file-earmark-pdf"></i>
                                        </button>
                                        
                                        <button class="btn btn-sm btn-outline-info btn-action" 
                                                @onclick="() => DescargarArchivo(evidencia)" 
                                                title="Descargar archivo de la evidencia">
                                            <i class="bi bi-download"></i>
                                        </button>
                                    }
                                    
                                    @if (evidencia.Estado == "Pendiente")
                                    {
                                        <button class="btn btn-sm btn-success btn-action" 
                                                @onclick="() => AprobarEvidencia(evidencia)" 
                                                title="Aprobar evidencia de investigación">
                                            <i class="bi bi-check-lg"></i>
                                        </button>
                                        
                                        <button class="btn btn-sm btn-danger btn-action" 
                                                @onclick="() => RechazarEvidencia(evidencia)" 
                                                title="Rechazar evidencia con comentarios">
                                            <i class="bi bi-x-lg"></i>
                                        </button>
                                    }
                                    else if (evidencia.Estado == "Rechazada" && !string.IsNullOrEmpty(evidencia.MotivoRechazo))
                                    {
                                        <button class="btn btn-sm btn-outline-danger btn-action" 
                                                @onclick="() => VerMotivoRechazo(evidencia)" 
                                                title="Ver motivo del rechazo">
                                            <i class="bi bi-exclamation-triangle"></i>
                                        </button>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

<!-- Modal para revisar evidencia - DESHABILITADO: Ahora usamos botones separados -->
@* @if (evidenciaEnRevision != null)
{
    <div class="modal fade show" style="display: block;" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header" style="background-color: #8a1538; color: white;">
                    <h5 class="modal-title">Revisar Evidencia de Investigación</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CerrarModalRevision"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-8">
                            <!-- Información de la evidencia -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0">Información de la Evidencia</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <strong>Docente:</strong> @evidenciaEnRevision.DocenteCedula<br>
                                            <strong>Tipo:</strong> @evidenciaEnRevision.TipoEvidencia<br>
                                            <strong>Título:</strong> @evidenciaEnRevision.TituloProyecto<br>
                                            <strong>Institución:</strong> @evidenciaEnRevision.InstitucionFinanciadora<br>
                                        </div>
                                        <div class="col-md-6">
                                            <strong>Rol:</strong> @evidenciaEnRevision.RolInvestigador<br>
                                            <strong>Código:</strong> @(evidenciaEnRevision.CodigoProyecto ?? "N/A")<br>
                                            <strong>Área:</strong> @(evidenciaEnRevision.AreaTematica ?? "N/A")<br>
                                            <strong>Duración:</strong> @evidenciaEnRevision.MesesDuracion meses<br>
                                        </div>
                                    </div>
                                    
                                    @if (!string.IsNullOrEmpty(evidenciaEnRevision.Descripcion))
                                    {
                                        <hr>
                                        <strong>Descripción:</strong><br>
                                        <p>@evidenciaEnRevision.Descripcion</p>
                                    }
                                    
                                    <hr>
                                    <strong>Período:</strong> 
                                    @evidenciaEnRevision.FechaInicio.ToString("dd/MM/yyyy") - 
                                    @(evidenciaEnRevision.FechaFin?.ToString("dd/MM/yyyy") ?? "En curso")
                                </div>
                            </div>

                            <!-- Formulario de revisión -->
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">Decisión de Revisión</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="decision" id="aprobar" 
                                                   @onchange="() => decisionAprobada = true" />
                                            <label class="form-check-label text-success" for="aprobar">
                                                <i class="bi bi-check-circle"></i> Aprobar
                                            </label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="decision" id="rechazar" 
                                                   @onchange="() => decisionAprobada = false" />
                                            <label class="form-check-label text-danger" for="rechazar">
                                                <i class="bi bi-x-circle"></i> Rechazar
                                            </label>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">
                                            @(decisionAprobada == true ? "Comentarios (opcional):" : "Motivo del rechazo (requerido):")
                                        </label>
                                        <textarea class="form-control" @bind="comentariosRevision" rows="4"
                                                  placeholder="@(decisionAprobada == true ? "Comentarios adicionales sobre la evidencia..." : "Explique detalladamente por qué se rechaza esta evidencia...")"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <!-- Visualizador de PDF -->
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">Archivo PDF</h6>
                                </div>
                                <div class="card-body p-2">
                                    @if (isLoadingPdf)
                                    {
                                        <div class="d-flex justify-content-center align-items-center" style="height: 400px;">
                                            <div class="spinner-border" role="status">
                                                <span class="visually-hidden">Cargando PDF...</span>
                                            </div>
                                        </div>
                                    }
                                    else if (!string.IsNullOrEmpty(pdfDataUrl))
                                    {
                                        <div class="pdf-viewer-container">
                                            <iframe src="@pdfDataUrl" style="width: 100%; height: 400px; border: none;"></iframe>
                                        </div>
                                        <div class="mt-2 text-center">
                                            <button class="btn btn-sm btn-outline-primary" @onclick="AbrirPdfEnNuevaVentana">
                                                <i class="bi bi-box-arrow-up-right"></i> Abrir en nueva ventana
                                            </button>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="alert alert-warning">
                                            No se pudo cargar el archivo PDF.
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CerrarModalRevision">Cancelar</button>
                    <button type="button" class="btn @(decisionAprobada == true ? "btn-success" : "btn-danger")" 
                            @onclick="GuardarRevision" 
                            disabled="@(decisionAprobada == null || (!decisionAprobada.Value && string.IsNullOrWhiteSpace(comentariosRevision)) || isGuardandoRevision)">
                        @if (isGuardandoRevision)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        @(decisionAprobada == true ? "Aprobar Evidencia" : "Rechazar Evidencia")
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
} *@

<!-- Modal para mostrar motivo de rechazo -->
@if (evidenciaRechazada != null)
{
    <div class="modal fade show" style="display: block;" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header modal-header-danger">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>Motivo de Rechazo
                    </h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CerrarMotivoRechazo"
                            title="Cerrar ventana" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <div class="rejection-info">
                        <h6 class="mb-3">
                            <i class="bi bi-info-circle-fill text-custom me-2"></i>
                            Información de la Evidencia
                        </h6>
                        <h6>@evidenciaRechazada.TituloProyecto</h6>
                        <p><strong>Docente:</strong> @evidenciaRechazada.DocenteCedula</p>
                    </div>
                    
                    <div class="alert alert-danger">
                        <h6 class="mb-2">
                            <i class="bi bi-x-circle-fill me-2"></i>Motivo del Rechazo:
                        </h6>
                        <p class="mb-0">@evidenciaRechazada.MotivoRechazo</p>
                    </div>
                    
                    @if (!string.IsNullOrEmpty(evidenciaRechazada.ComentariosRevision))
                    {
                        <div class="alert alert-warning">
                            <h6 class="mb-2">
                                <i class="bi bi-chat-text-fill me-2"></i>Comentarios Adicionales:
                            </h6>
                            <p class="mb-0">@evidenciaRechazada.ComentariosRevision</p>
                        </div>
                    }
                    
                    @if (evidenciaRechazada.FechaRevision.HasValue)
                    {
                        <div class="text-muted mt-3">
                            <small>
                                <i class="bi bi-calendar-check me-1"></i>
                                Fecha de revisión: <EcuadorDateDisplay Date="evidenciaRechazada.FechaRevision.Value" 
                                                                   Format="datetime" 
                                                                   CssClass="fw-bold" />
                            </small>
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CerrarMotivoRechazo"
                            title="Cerrar ventana">
                        <i class="bi bi-x-circle me-2"></i>Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

<!-- Modal para confirmar rechazo -->
@if (showModalRechazo && evidenciaEnRevision != null)
{
    <div class="modal fade show" style="display: block;" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header modal-header-danger">
                    <h5 class="modal-title">
                        <i class="bi bi-x-circle-fill me-2"></i>Rechazar Evidencia
                    </h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CerrarModalRechazo"
                            title="Cerrar ventana sin realizar cambios" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <div class="rejection-info">
                        <h6 class="mb-3">
                            <i class="bi bi-info-circle-fill text-custom me-2"></i>
                            Información de la Evidencia
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Docente:</strong> @evidenciaEnRevision.DocenteCedula<br>
                                <strong>Tipo:</strong> @evidenciaEnRevision.TipoEvidencia
                            </div>
                            <div class="col-md-6">
                                <strong>Evidencia ID:</strong> @evidenciaEnRevision.Id.ToString()[..8]...<br>
                                <strong>Fecha:</strong> <EcuadorDateDisplay Date="evidenciaEnRevision.FechaCreacion" 
                                                                       Format="date" 
                                                                       CssClass="fw-bold" />
                            </div>
                        </div>
                        <div class="mt-2">
                            <strong>Título:</strong> @evidenciaEnRevision.TituloProyecto
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold text-danger">
                            <i class="bi bi-exclamation-triangle me-1"></i>
                            Motivo del Rechazo *
                        </label>
                        <textarea class="form-control" rows="4" @bind="comentariosRevision" 
                                  placeholder="Explique detalladamente por qué se rechaza la evidencia. Este motivo será visible para el docente." 
                                  required title="Campo obligatorio: debe explicar por qué se rechaza"></textarea>
                        <div class="form-text">
                            <small class="text-muted">
                                <i class="bi bi-info-circle me-1"></i>
                                Este comentario será enviado al docente por correo electrónico.
                            </small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CerrarModalRechazo"
                            title="Cancelar operación sin realizar cambios">
                        <i class="bi bi-arrow-left me-2"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-danger" @onclick="ConfirmarRechazo" 
                            disabled="@(string.IsNullOrWhiteSpace(comentariosRevision) || isGuardandoRevision)"
                            title="Confirmar rechazo de la evidencia">
                        @if (isGuardandoRevision)
                        {
                            <span class="spinner-border spinner-border-sm me-2" aria-hidden="true"></span>
                            <span>Procesando...</span>
                        }
                        else
                        {
                            <i class="bi bi-x-lg me-2"></i>
                            <span>Confirmar Rechazo</span>
                        }
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

<!-- Modal para visualizar PDF -->
@if (showVisualizarModal && !string.IsNullOrEmpty(pdfDataUrl))
{
    <div class="modal fade show" style="display: block;" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header modal-header-custom">
                    <h5 class="modal-title">
                        <i class="bi bi-file-earmark-pdf me-2"></i>
                        Visualizar PDF - @(evidenciaParaVisualizar?.TituloProyecto ?? "Documento")
                    </h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CerrarModalVisualizarPDF" 
                            title="Cerrar visualizador de PDF" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body p-0">
                    @if (isLoadingPdf)
                    {
                        <div class="pdf-loading">
                            <div class="spinner-border text-custom" role="status">
                                <span class="visually-hidden">Cargando PDF...</span>
                            </div>
                            <p class="mt-3 text-custom">Cargando evidencia...</p>
                            <small class="text-muted">Por favor, espere mientras se carga el documento</small>
                        </div>
                    }
                    else if (!string.IsNullOrEmpty(pdfDataUrl))
                    {
                        <div class="pdf-viewer-container">
                            <iframe src="@pdfDataUrl" style="width: 100%; height: 600px; border: none;" frameborder="0"></iframe>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-danger m-3" role="alert">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-exclamation-triangle-fill me-3 fs-4"></i>
                                <div>
                                    <h6 class="mb-1">Error al cargar la evidencia</h6>
                                    <p class="mb-0">No se pudo cargar el archivo PDF.</p>
                                    <small class="text-muted">
                                        Por favor, intente nuevamente o contacte al administrador del sistema.
                                    </small>
                                </div>
                            </div>
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CerrarModalVisualizarPDF"
                            title="Cerrar visualizador de PDF">
                        <i class="bi bi-x-circle me-2"></i>Cerrar
                    </button>
                    @if (!string.IsNullOrEmpty(pdfDataUrl) && !isLoadingPdf)
                    {
                        <button type="button" class="btn btn-primary-custom" @onclick="AbrirPdfEnNuevaVentana"
                                title="Abrir PDF en nueva ventana del navegador">
                            <i class="bi bi-box-arrow-up-right me-2"></i>Abrir en nueva ventana
                        </button>
                    }
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

<!-- Modal de Detalle de Evidencia -->
@if (showDetalleModal && evidenciaSeleccionada != null)
{
    <div class="modal fade show" style="display: block;" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header modal-header-custom">
                    <h5 class="modal-title">
                        <i class="bi bi-search me-2"></i>
                        Detalle de la Evidencia de Investigación
                    </h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CerrarDetalleModal" 
                            title="Cerrar ventana de detalles"></button>
                </div>
                <div class="modal-body modal-body-detail">
                    <!-- Encabezado del Reporte -->
                    <div class="detail-report-header">
                        <div class="detail-report-title">
                            <i class="bi bi-search me-2"></i>Reporte de Evidencia de Investigación
                        </div>
                        <div class="detail-report-subtitle">
                            Evidencia ID: @evidenciaSeleccionada.Id.ToString()[..8]... | Fecha de Solicitud: <EcuadorDateDisplay Date="evidenciaSeleccionada.FechaCreacion" 
                                                                                                                    Format="datetime" 
                                                                                                                    CssClass="fw-bold" />
                        </div>
                    </div>

                    <!-- Información General Consolidada -->
                    <div class="detail-report-content">
                        <div class="detail-info-grid">
                            <!-- Información del Docente -->
                            <div class="detail-info-item">
                                <div class="detail-info-label">
                                    <i class="bi bi-person-badge me-2"></i>Docente
                                </div>
                                <div class="detail-info-value large">
                                    <strong>@evidenciaSeleccionada.DocenteCedula</strong>
                                </div>
                            </div>

                            <!-- Tipo de Evidencia -->
                            <div class="detail-info-item">
                                <div class="detail-info-label">
                                    <i class="bi bi-tags me-2"></i>Tipo de Evidencia
                                </div>
                                <div class="detail-info-value">
                                    <span class="badge bg-light text-dark">@evidenciaSeleccionada.TipoEvidencia</span>
                                </div>
                            </div>

                            <!-- Título del Proyecto -->
                            <div class="detail-info-item detail-full-width">
                                <div class="detail-info-label">
                                    <i class="bi bi-journal-text me-2"></i>Título del Proyecto
                                </div>
                                <div class="detail-info-value">
                                    @evidenciaSeleccionada.TituloProyecto
                                </div>
                            </div>

                            <!-- Código del Proyecto -->
                            @if (!string.IsNullOrEmpty(evidenciaSeleccionada.CodigoProyecto))
                            {
                                <div class="detail-info-item">
                                    <div class="detail-info-label">
                                        <i class="bi bi-hash me-2"></i>Código del Proyecto
                                    </div>
                                    <div class="detail-info-value">
                                        @evidenciaSeleccionada.CodigoProyecto
                                    </div>
                                </div>
                            }

                            <!-- Institución Financiadora -->
                            <div class="detail-info-item">
                                <div class="detail-info-label">
                                    <i class="bi bi-building me-2"></i>Institución Financiadora
                                </div>
                                <div class="detail-info-value">
                                    @evidenciaSeleccionada.InstitucionFinanciadora
                                </div>
                            </div>

                            <!-- Rol del Investigador -->
                            <div class="detail-info-item">
                                <div class="detail-info-label">
                                    <i class="bi bi-person-gear me-2"></i>Rol del Investigador
                                </div>
                                <div class="detail-info-value">
                                    @evidenciaSeleccionada.RolInvestigador
                                </div>
                            </div>

                            <!-- Área Temática -->
                            @if (!string.IsNullOrEmpty(evidenciaSeleccionada.AreaTematica))
                            {
                                <div class="detail-info-item">
                                    <div class="detail-info-label">
                                        <i class="bi bi-bookmark me-2"></i>Área Temática
                                    </div>
                                    <div class="detail-info-value">
                                        @evidenciaSeleccionada.AreaTematica
                                    </div>
                                </div>
                            }

                            <!-- Fecha de Inicio -->
                            <div class="detail-info-item">
                                <div class="detail-info-label">
                                    <i class="bi bi-calendar-event me-2"></i>Fecha de Inicio
                                </div>
                                <div class="detail-info-value">
                                    @evidenciaSeleccionada.FechaInicio.ToString("dd/MM/yyyy")
                                </div>
                            </div>

                            <!-- Fecha de Fin -->
                            <div class="detail-info-item">
                                <div class="detail-info-label">
                                    <i class="bi bi-calendar-check me-2"></i>Fecha de Fin
                                </div>
                                <div class="detail-info-value">
                                    @(evidenciaSeleccionada.FechaFin?.ToString("dd/MM/yyyy") ?? "En curso")
                                </div>
                            </div>

                            <!-- Duración -->
                            <div class="detail-info-item">
                                <div class="detail-info-label">
                                    <i class="bi bi-clock me-2"></i>Duración
                                </div>
                                <div class="detail-info-value">
                                    <span class="badge bg-info text-white">@evidenciaSeleccionada.MesesDuracion meses</span>
                                </div>
                            </div>

                            <!-- Descripción -->
                            @if (!string.IsNullOrEmpty(evidenciaSeleccionada.Descripcion))
                            {
                                <div class="detail-info-item detail-full-width">
                                    <div class="detail-info-label">
                                        <i class="bi bi-text-paragraph me-2"></i>Descripción
                                    </div>
                                    <div class="detail-info-value">
                                        @evidenciaSeleccionada.Descripcion
                                    </div>
                                </div>
                            }

                            <!-- Estado -->
                            <div class="detail-info-item">
                                <div class="detail-info-label">
                                    <i class="bi bi-flag me-2"></i>Estado Actual
                                </div>
                                <div class="detail-info-value">
                                    <span class="badge @GetBadgeClass(evidenciaSeleccionada.Estado)">
                                        @evidenciaSeleccionada.Estado
                                    </span>
                                    @if (evidenciaSeleccionada.Estado != "Pendiente" && evidenciaSeleccionada.FechaRevision.HasValue)
                                    {
                                        <br><small class="text-muted">Revisado el <EcuadorDateDisplay Date="evidenciaSeleccionada.FechaRevision.Value" 
                                                                                                        Format="datetime" 
                                                                                                        CssClass="text-muted" /></small>
                                    }
                                </div>
                            </div>

                            <!-- Fecha de Creación -->
                            <div class="detail-info-item">
                                <div class="detail-info-label">
                                    <i class="bi bi-calendar-plus me-2"></i>Fecha de Solicitud
                                </div>
                                <div class="detail-info-value">
                                    <EcuadorDateDisplay Date="evidenciaSeleccionada.FechaCreacion" 
                                                       Format="datetime" 
                                                       CssClass="fw-bold" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sección de Archivo Adjunto -->
                    @if (evidenciaSeleccionada.TieneArchivo && !string.IsNullOrEmpty(evidenciaSeleccionada.ArchivoNombre))
                    {
                        <div class="section-divider"></div>
                        <div class="detail-section">
                            <div class="detail-label">
                                <i class="bi bi-paperclip me-2"></i>Archivo Adjunto
                            </div>
                            <div class="file-info">
                                <div class="file-icon">
                                    <i class="bi bi-file-earmark-pdf"></i>
                                </div>
                                <div class="flex-grow-1">
                                    @(evidenciaSeleccionada.ArchivoNombre ?? "evidencia.pdf")
                                </div>
                                <div class="ms-auto">
                                    <button class="btn btn-sm btn-outline-secondary" @onclick="() => VisualizarArchivo(evidenciaSeleccionada)"
                                            title="Visualizar archivo PDF">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-info" @onclick="() => DescargarArchivo(evidenciaSeleccionada)"
                                            title="Descargar archivo">
                                        <i class="bi bi-download"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    }

                    <!-- Sección de Motivo de Rechazo -->
                    @if (evidenciaSeleccionada.Estado == "Rechazada" && !string.IsNullOrEmpty(evidenciaSeleccionada.MotivoRechazo))
                    {
                        <div class="section-divider"></div>
                        <div class="detail-section">
                            <div class="detail-label">
                                <i class="bi bi-exclamation-triangle me-2"></i>Motivo de Rechazo
                            </div>
                            <div class="alert alert-danger">
                                <p class="mb-0">@evidenciaSeleccionada.MotivoRechazo</p>
                            </div>
                            @if (!string.IsNullOrEmpty(evidenciaSeleccionada.ComentariosRevision))
                            {
                                <div class="alert alert-warning">
                                    <h6 class="mb-2">Comentarios Adicionales:</h6>
                                    <p class="mb-0">@evidenciaSeleccionada.ComentariosRevision</p>
                                </div>
                            }
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CerrarDetalleModal"
                            title="Cerrar ventana de detalles">
                        <i class="bi bi-x-circle me-2"></i>Cerrar
                    </button>
                    
                    @if (evidenciaSeleccionada.TieneArchivo && !string.IsNullOrEmpty(evidenciaSeleccionada.ArchivoNombre))
                    {
                        <button type="button" class="btn btn-outline-secondary" @onclick="() => VisualizarArchivo(evidenciaSeleccionada)"
                                title="Visualizar archivo PDF">
                            <i class="bi bi-eye me-2"></i>Visualizar PDF
                        </button>
                        <button type="button" class="btn btn-outline-info" @onclick="() => DescargarArchivo(evidenciaSeleccionada)"
                                title="Descargar archivo">
                            <i class="bi bi-download me-2"></i>Descargar
                        </button>
                    }
                    
                    @if (evidenciaSeleccionada.Estado == "Pendiente")
                    {
                        <button type="button" class="btn btn-success" @onclick="() => AprobarEvidencia(evidenciaSeleccionada)"
                                title="Aprobar evidencia">
                            <i class="bi bi-check-lg me-2"></i>Aprobar
                        </button>
                        <button type="button" class="btn btn-danger" @onclick="() => RechazarEvidencia(evidenciaSeleccionada)"
                                title="Rechazar evidencia">
                            <i class="bi bi-x-lg me-2"></i>Rechazar
                        </button>
                    }
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}
